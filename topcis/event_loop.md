
# Что такое event-loop и как он работает?

## Содержание

- [Call stack или Стек вызовов](#call-stack-или-стек-вызовов)
- [Что такое очередь?](#что-такое-очередь)
- [Что такое стек?](#что-такое-стек)
- [В чем различие между микрозадачи и макрозадачи?](#в-чем-различие-между-микрозадачи-и-макрозадачи)
- [Откуда берутся макрозадачи?](#откуда-берутся-макрозадачи)
- [Откуда берутся микрозадачи?](#откуда-берутся-микрозадачи)
- [Event loop](#event-loop)
- [Источники данных](#источники-данных)

## Call stack или Стек вызовов

Первое определение

> Стек вызовов — механизм, с помощью которого интерпретатор JavaScript определяет, какая функция выполняется в настоящее время, какие функции вызываются из этой функции и т.д.

Чуть более развернутое определение

> Стек вызовов (call stack) - это механизм для интерпретаторов (таких как интерпретатор JavaScript в веб-браузере) для отслеживания текущего местонахождения интерпретатора в скрипте, который вызывает несколько функций, — какая из функций выполняется на данный момент, какие функции вызываются изнутри этой (выполняемой) функции, какая будет вызвана следующей и т. д.

Еще одно определение и оно очень интересное

> Стек вызовов - это стек LIFO (Last In First Out). Это место, куда задача добавляется из очереди макрозадач или очереди микрозадач.

Здесь появились два термина - макрозадач и микрозадач

### Что такое очередь?

> Очередь - список элементов, организованных по принципу FIFO (англ. first in, first out «первым пришёл — первым ушёл») 

### Что такое стек?

> Стек - список элементов, организованных по принципу LIFO (англ. last in — first out, «последним пришёл — первым вышел»)

Получается, что у стека есть две операции

- PUSH, положить элемент в конец
- POP, взять последний элемент

Очень важным момент здесь является то, что call stack - механизм интерпретатора (к примеру **V8**) в **веб-браузере**.

### В чем различие между микрозадачи и макрозадачи?

Разница между макро- и микрозадачами кажется незначительной. Все они помещаются в **стек вызовов** и запускаются в соответствующее время. Event loop извлекает задачу из стека вызовов одну за другой.

Но разница в приоритете, а именно:

> Event loop выполняет все **микро**задачи одну за другой, даже когда одна **микро**задача запланировала другую **микро**задачу, в то время как **макра**задачи выполняются по одной.

Теперь понятно, что есть просто задачи, которые добавляются в сек вызовов, но задачи могу быть разного типа (**микро** и **макро**)

### Откуда берутся макрозадачи?

- setTimeout() - известно, что это =)
- setImmediate() - Этот метод используется для прерывания длительно выполняющихся операций и запуска функции обратного вызова сразу после завершения браузером других операций, таких как события и обновления отображения.
- setInterval() - известно, что это =)
- requestAnimationFrame() - указывает браузеру на то, что вы хотите произвести анимацию, и просит его запланировать перерисовку на следующем кадре анимации. В качестве параметра метод получает функцию, которая будет вызвана перед перерисовкой.
- I/O
- UI rendering

### Откуда берутся микрозадачи?

Очень хорошее определение

> Макрозадача - это любой код JavaScript, выполнение которого запланировано с помощью стандартного механизма, такого как обратный вызов события, интервал или тайм-аут.

- Promise (then/catch/finally), await
- process.nextTick() - для Node
- queueMicrotask() - явно поместит задачу в очередь микрозадач.

## Event loop

И теперь самое главное

> Event loop - это бесконечный цикл, которые следит за `стеком вызовов` и выполняет все, что туда помещено по приципу «последним пришёл — первым вышел», а так же за один `проход` или `такт` выполняет все **микро**задачи а потом одну **макру**задачу

Как видно из определения выше, то вся суть заключается именно в типах задач.

Например, если не правильно реализовать рекурсивную функцию (в частности **микро**задачи), то стек вызов будет заполнены, а браузер не сможет выполнять ничего другого, пока не будут выполнены все **микро**задачи

## Примеры



## Источники данных

- [Как работают браузеры. Часть 2: парсинг и выполнение JS](https://habr.com/ru/company/kts/blog/678034/)
- [Event loop на medium](https://medium.com/globant/what-are-micro-tasks-and-macro-tasks-in-the-event-loop-29bc0abdd445)